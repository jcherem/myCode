import nuke

def update_layers():
    # Obtén el nodo actual
    node = nuke.thisNode()

    # Crea un conjunto para almacenar los nombres de las capas
    layers1 = set()
    layers2 = set()

    # Obtén el nodo conectado a la primera entrada
    input_node1 = node.input(0)

    # Si hay un nodo conectado a la entrada, obtén sus capas
    if input_node1 is not None:
        input_layers1 = input_node1.channels()

        # Itera sobre las capas y agrega el nombre de la capa al conjunto
        for layer in input_layers1:
            layer_name = layer.split('.')[0]
            layers1.add(layer_name)

    # Obtén el nodo conectado a la segunda entrada
    input_node2 = node.input(1)

    # Si hay un nodo conectado a la entrada, obtén sus capas
    if input_node2 is not None:
        input_layers2 = input_node2.channels()

        # Itera sobre las capas y agrega el nombre de la capa al conjunto
        for layer in input_layers2:
            layer_name = layer.split('.')[0]
            layers2.add(layer_name)

    # Actualiza los menús desplegables con los nombres de las capas
    node.knob('layer_menu1').setValues(list(layers1))
    node.knob('layer_menu2').setValues(list(layers1.union(layers2)))

def update_copy_nodes():
    # Obtén el nodo actual
    node = nuke.thisNode()

    # Configura los nodos Copy para usar las capas seleccionadas
    layer1 = node.knob('layer_menu1').value()
    layer2 = node.knob('layer_menu2').value()

    # Configura los nodos Copy para copiar los canales de las capas seleccionadas
    node.node('Copy1').knob('from0').setValue(layer1 + '.red')
    node.node('Copy1').knob('from1').setValue(layer1 + '.green')
    node.node('Copy1').knob('from2').setValue(layer1 + '.blue')
    node.node('Copy1').knob('from3').setValue(layer1 + '.alpha')

    node.node('Copy2').knob('from0').setValue(layer2 + '.red')
    node.node('Copy2').knob('from1').setValue(layer2 + '.green')
    node.node('Copy2').knob('from2').setValue(layer2 + '.blue')
    node.node('Copy2').knob('from3').setValue(layer2 + '.alpha')

# Crea un nodo Group con dos entradas
node = nuke.nodes.Group(inputs=[None, None])

# Añade dos nodos Copy al grupo
node.begin()
copy_node1 = nuke.nodes.Copy(inputs=[node.input(0)])
copy_node1.setName('Copy1')
copy_node2 = nuke.nodes.Copy(inputs=[copy_node1, node.input(1)])
copy_node2.setName('Copy2')
node.end()

# Añade dos menús desplegables para seleccionar capas
layer_menu1 = nuke.Enumeration_Knob('layer_menu1', 'Layer Menu 1', [])
layer_menu1.setFlag(nuke.STARTLINE)
layer_menu1.setTooltip('Select the layer for the first Copy node.')
layer_menu1.setAnimated()
layer_menu1.setExpression('update_copy_nodes()')
node.addKnob(layer_menu1)

layer_menu2 = nuke.Enumeration_Knob('layer_menu2', 'Layer Menu 2', [])
layer_menu2.setTooltip('Select the layer for the second Copy node.')
layer_menu2.setAnimated()
layer_menu2.setExpression('update_copy_nodes()')
node.addKnob(layer_menu2)

# Añade un botón para actualizar los menús desplegables de capas
update_button = nuke.PyScript_Knob('update_button', 'Update Layers', 'update_layers()')
node.addKnob(update_button)

import nuke

def update_layers():
    # Obtén el nodo actual
    node = nuke.thisNode()

    # Crea un conjunto para almacenar los nombres de las capas
    layers = set()

    # Itera sobre las dos entradas del nodo
    for i in range(2):
        # Obtén el nodo conectado a la entrada
        input_node = node.input(i)

        # Si hay un nodo conectado a la entrada, obtén sus capas
        if input_node is not None:
            input_layers = input_node.channels()

            # Itera sobre las capas y agrega el nombre de la capa al conjunto
            for layer in input_layers:
                layer_name = layer.split('.')[0]
                layers.add(layer_name)

    # Actualiza los menús desplegables con los nombres de las capas
    node.knob('layer_menu1').setValues(list(layers))
    node.knob('layer_menu2').setValues(list(layers))

def perform_operation():
    # Obtén el nodo actual
    node = nuke.thisNode()

    # Configura los nodos Copy para usar las capas seleccionadas
    layer1 = node.knob('layer_menu1').value()
    layer2 = node.knob('layer_menu2').value()

    # Configura los nodos Copy para copiar los canales de las capas seleccionadas
    node.node('Copy1').knob('from0').setValue(layer1 + '.red')
    node.node('Copy1').knob('from1').setValue(layer1 + '.green')
    node.node('Copy1').knob('from2').setValue(layer1 + '.blue')
    node.node('Copy1').knob('from3').setValue(layer1 + '.alpha')

    node.node('Copy2').knob('from0').setValue(layer2 + '.red')
    node.node('Copy2').knob('from1').setValue(layer2 + '.green')
    node.node('Copy2').knob('from2').setValue(layer2 + '.blue')
    node.node('Copy2').knob('from3').setValue(layer2 + '.alpha')

# Crea un nodo Group con dos entradas
node = nuke.nodes.Group(inputs=[None, None])

# Añade dos nodos Copy al grupo
node.begin()
copy_node1 = nuke.nodes.Copy(inputs=[None])
copy_node1.setName('Copy1')
copy_node2 = nuke.nodes.Copy(inputs=[copy_node1])
copy_node2.setName('Copy2')
node.end()

# Añade dos menús desplegables para seleccionar capas
layer_menu1 = nuke.Enumeration_Knob('layer_menu1', 'Layer Menu 1', [])
layer_menu2 = nuke.Enumeration_Knob('layer_menu2', 'Layer Menu 2', [])
node.addKnob(layer_menu1)
node.addKnob(layer_menu2)

# Añade un botón para actualizar los menús desplegables de capas
update_button = nuke.PyScript_Knob('update_button', 'Update Layers', 'update_layers()')
node.addKnob(update_button)

# Añade un botón para realizar la operación
perform_button = nuke.PyScript_Knob('perform_button', 'Perform Operation', 'perform_operation()')
node.addKnob(perform_button)

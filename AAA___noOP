import nuke

def update_layers():
    # Obtén el nodo actual
    node = nuke.thisNode()

    # Obtén todos los nodos conectados al nodo actual
    input_nodes = node.dependencies()

    # Crea un conjunto para almacenar los nombres de las capas
    layers = set()

    # Itera sobre todos los nodos de entrada
    for input_node in input_nodes:
        # Obtén las capas del nodo de entrada
        input_layers = input_node.channels()

        # Itera sobre las capas y agrega el nombre de la capa al conjunto
        for layer in input_layers:
            layer_name = layer.split('.')[0]
            layers.add(layer_name)

    # Actualiza los menús desplegables con los nombres de las capas
    node.knob('layer_menu1').setValues(list(layers))
    node.knob('layer_menu2').setValues(list(layers))

def perform_operation():
    # Obtén el nodo actual
    node = nuke.thisNode()

    # Configura el nodo Merge para usar las capas seleccionadas
    layer1 = node.knob('layer_menu1').value()
    layer2 = node.knob('layer_menu2').value()

    # Configura el nodo Merge para realizar la operación de stencil
    node.knob('operation').setValue('stencil')
    node.knob('bbox').setValue(layer1)
    node.knob('bbox2').setValue(layer2)

# Crea un nodo Group
node = nuke.createNode('Group')

# Añade un nodo Merge al grupo
merge_node = nuke.nodes.Merge(inputs=[node])
node.begin()
merge_node.setInput(0, None)
node.end()

# Añade dos menús desplegables para seleccionar capas
layer_menu1 = nuke.Enumeration_Knob('layer_menu1', 'Layer Menu 1', [])
layer_menu2 = nuke.Enumeration_Knob('layer_menu2', 'Layer Menu 2', [])
node.addKnob(layer_menu1)
node.addKnob(layer_menu2)

# Añade un botón para actualizar los menús desplegables de capas
update_button = nuke.PyScript_Knob('update_button', 'Update Layers', 'update_layers()')
node.addKnob(update_button)

# Añade un botón para realizar la operación
perform_button = nuke.PyScript_Knob('perform_button', 'Perform Operation', 'perform_operation()')
node.addKnob(perform_button)
